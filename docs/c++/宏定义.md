---
title: 宏定义
date: 2024-08-15
tags:
 - C++
categories:
 - C++
---

## #define

#define命令是C语言中的一个宏定义命令，它用来将一个标识符定义为一个字符串，该标识符被称为宏名，被定义的字符串称为替换文本

1. 简单宏定义

    #define <宏名> <字符串>

    #define PI 3.1415926

2. 带参数的宏定义

    #define <宏名>(<参数表>) <宏体>
    
    #define A(x) x

一个标识符被宏定义后，该标识符便是一个宏名。在程序编译前，会先将宏名用被定义的字符串替换，这称为宏替换，替换后才进行编译


## 宏替换发生的时机

### 预处理

1. 文件包含
    把源程序中的#include扩展为文件正文，即把包含的.h文件找到并展开到#include所在处

2. 条件编译

    预处理器根据#if和#ifdef等编译命令及其后的条件，将源程序中的某部分包含进来或排除在外，通常把排除在外的语句转换为空行

3. 宏展开

    预处理器将源程序文件中出现的对宏的引用展开成相应的宏定义。

    **在这个阶段所进行的工作只是纯粹的替换和展开，没有任何计算功能**

## #define使用中常见问题解析

### 简单宏定义使用中出现的问题

```cpp

#define N 2+2

void main(){
    int a = N*N;
    printf("%d", a);
}
```

替换结果: `int a = 2 + 2 * 2 + 2`， 结果`a==8`

宏展开是在预处理阶段完成的，这个阶段把替换文本只是看作一个字符串，并不会有任何的计算发生，在展示时是在宏N出现的地方，只是简单地使用2+2来代替N，并不会增添任何的符号

解决办法:将宏定义写成`#define N (2+2)`

### 带参数的宏定义出现的问题

```cpp
#define area(x) x*x

void main(){
    int a = area(2+2);
    printf("%d", a);
}
```

替换结果: `int a = 2 + 2 * 2 + 2`

解决办法: `#define area(x) ((x)*(x))`

## #define中的三个特殊符号: #, ##, #@

1. #define Conn(x, y) x##y
2. #define ToChar(x) #@x
3. #define ToString #x

x##y表示x连接y
```cpp
int a = Conn(123, 456);
// 宏展开时
int a = 123456;
```

#@x表示给x加上单引号，结果返回一个`const char`
```cpp
char a = ToChar(1);
// 宏展开时
char a = '1';
```

#x表示给x加上双引号
```cpp
char* str = ToString(123);
// 宏展开时
char* str = "123";
```

## 常用的宏定义

### 防止一个头文件被重复包含

```cpp
#ifndef BODYDEF_H
#define BODYDEF_H
// 头文件内容

#endif
```
### 将一个字母转换为大写

```cpp
#define UPCASE(c) ((c >= 'a' && c <= 'z') ? (c - 0x20) : (c))
void main() {
    cout << char(UPCASE('b')) << endl;
}
```

### 返回数组元素的个数
```cpp
#define ARR_SIZE(a) (sizeof((a)) / sizeof((a[0])))
```
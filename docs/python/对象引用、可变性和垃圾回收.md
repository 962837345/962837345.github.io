---
title: 对象引用、可变性和垃圾回收
date: 2021-05-12
tags:
  - python
categories:
  - Python之旅
---

## Python变量到底是什么

python和Java的变量本质不一样，Java是定义好一个类型，然后申请一个空间（大小和类型有关），相当于一个盒子只能放固定类型，python变量的实质是一个指针（大小都相同），指向int，string等等，相当于一个便利贴（先生成对象，然后贴便利贴），可以贴在很多东西上

```py
a = [1, 2]
b = a
b.append(3)

# a和b贴在同一个对象上面
print(a)  # [1, 2, 3]
print(a is b)  # True
print(id(a), id(b))  # 2237197407552  2237197407552
```

## ==和is的区别

**is是判断是否是同一个对象，而==是判断值是否相等**

```py
a = [1, 2, 3]
b = [1, 2, 3]

print(a is b)  # False
print(id(a), id(b))  # 2050771801408  2050771801408
# 判断相等时因为魔法函数(list中的__eq__)
print(a == b)  # True
```

对于小整数（python内部的intern机制），将一定范围的小整数（大概是5~256），会建立全局唯一的变量，下次再遇到时直接指向之前的，小段的字符串，Python都有机制

```py
a = 1
b = 1
print(a is b)  # True
print(id(a), id(b))  # 1993128634672 1993128634672
```

## del语句和垃圾回收

python中垃圾回收算法采用引用计数(cpython2.0之后就不仅仅是)

垃圾回收方法还有：标记清除、分代回收

也可以自己写在类中写垃圾回收的逻辑（`__del__`魔法函数）

## 一个经典的错误

1. 列表（可变对象），`+=`是直接修改a2，而不是创建一个新的list，因此a2也变化了

   ```py
   def add(a, b):
       a += b
       return a
   
   
   if __name__ == '__main__':
       a1 = 1
       b1 = 2
       c1 = add(a1, b1)
       print(c1)  # 3
       print(c1, b1)  # 3 2
   
       # 列表（可变对象），+=是直接修改a2，而不是创建一个新的list，因此a2也变化了
       a2 = [1, 2]
       b2 = [3, 4]
       c2 = add(a2, b2)
       print(c2)  # [1, 2, 3, 4]
       print(a2, b2)  # [1, 2, 3, 4] [3, 4]
   
       # 元组是不可变对象
       a3 = (1, 2)
       b3 = (3, 4)
       c3 = add(a3, b3)
       print(c3)  # (1, 2, 3, 4)
       print(a3, b3)  # (1, 2) (3, 4)
   ```

2. 类中传递的列表是一个可变对象，com2和com3都没有传递list，因此使用的是默认的list，其实是公用的一个对象（且可变）

   ```py
   class Company():
       def __init__(self, name, staffs=[]):
           self.name = name
           self.staffs = staffs
   
       def add(self, staff_name):
           self.staffs.append(staff_name)
   
       def remove(self, staff_name):
           self.staffs.remove(staff_name)
   
   
   com1 = Company('HH', ['A1', 'A2'])
   com1.add('A3')
   com1.remove('A2')
   print(com1.staffs)  # ['A1', 'A3']
   
   com2 = Company('XX')
   com2.add('A4')
   print(com2.staffs)  # ['A4']
   
   # 默认值
   print(Company.__init__.__defaults__)  # (['A4'],)
   
   com3 = Company('LL')
   com3.add('A5')
   print(com2.staffs)  # ['A4', 'A5']
   print(com3.staffs)  # ['A4', 'A5']
   
   # com2.staffs和com3.staffs是同一个对象
   print(com2.staffs is com3.staffs)  # True
   
   # 默认值
   print(Company.__init__.__defaults__)  # (['A4', 'A5'],)
   ```

   
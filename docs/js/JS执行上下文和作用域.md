---
title: JS执行上下文和作用域
date: 2020-07-24
tags:
 - JS
categories:
 - 前端笔记
---

## 执行上下文

JS代码在执行前，JS引擎总要做一番准备工作，这份工作其实就是创建对应的执行上下文

执行上下文有且只有三类

* 全局执行上下文
* 函数上下文
* eval上下文

:::tip

由于eval一般不会使用，这里不做讨论

:::

### 全局执行上下文

全局执行上下文只有一个，在客户端中**一般由浏览器创建**，也就是`window`对象，我们能通过`this`直接访问到它

### 函数执行上下文

函数执行上下文可存在无数个，每当一个函数被调用时都会创建一个函数上下文。需要注意的是，**同一个函数被多次调用，都会创建一个新的上下文**

### 执行上下文栈（执行栈）

执行上下文栈（简称执行栈）也叫调用栈，**执行栈用于存储代码执行期间创建的所有上下文**，具有先进后出的特性

JS代码首次运行，都会**先创建一个全局执行上下文并压入到执行栈中**，之后每当有函数被调用，都会创建一个新的函数执行上下文并压入栈内。由于执行栈先进后出的特性，所以可以理解为，JS代码执行完毕前在执行栈底部永远有个全局执行上下文

```js
/* 这里可以理解为调用f1，f1入栈
 * f1中调用f2，f2入栈
 * f2中调用f3，f3入栈
 * f3打印3，执行完毕出栈
 * f2打印2，执行完毕出栈
 * f1打印1，执行完毕出栈
 */
function f1() {
    f2();
    console.log(1);
};

function f2() {
    f3();
    console.log(2);
};

function f3() {
    console.log(3);
};

f1();//3 2 1
```

执行上下文分为**创建阶段**和**执行阶段**

创建阶段会**变量提升**和**函数声明提前**

## 全局作用域

* 直接编写在script标签中的JS代码，都在全局作用域中
* 全局作用域在页面打开时创建，在页面关闭时销毁
* 在全局作用域中有一个全局对象window
* 在全局作用域中
  * 创建的变量都会作为window对象的属性保存
  * 创建的函数都会作为window对象的方法保存
* 全局作用域中的变量都是全局变量
  * 在页面的任意的部分都可以访问到

## 函数作用域
* 调用函数时创建函数作用域，函数执行完毕后，函数作用域销毁
* 每调用一次函数就会创建一个新的函数作用域，它们之间是互相独立的
* 在函数作用域中可以访问到全局作用域的变量
* 在全局作用域中无法访问到函数作用域中的变量
* 当函数作用域操作一个变量时，它会先在自身作用域中找，找不到再向上级作用域中找，直到找到全局作用域
* 在函数作用域也有声明提前的特性
  * 使用var关键字声明的变量，会在函数中所有代码执行之前声明
  * 函数声明也会在函数中所有代码执行之前声明
* 在函数中不是var关键字声明的变量都会被作为全局变量
* 函数中的形参会在函数作用域中声明了变量

示例1；
```js
var a = 123;
function fun() {
  alert(a);         //undefined
  var a = 456;      //这里的a被var关键字提前声明
}
fun();
alert(a)            //123
```
示例2：
```js
var a = 123;
function fun() {
  alert(a);         //123
  a = 456;          
}
fun();
alert(a)            //456
```
示例3：
```js
var a = 123;
function fun(a) {
  alert(a);         //undefined
  a = 456;          
}
fun();
alert(a)            //123
```
示例4：
```js
var a = 123;
function fun(a) {
  alert(a);         //123
  a = 456;          
}
fun(123);
alert(a)            //123
```



## 变量的提前声明
使用var关键字声明的变量，会在所以的代码执行之前被声明（但是不会赋值）

如果不使用var关键字，则变量不会被声明提前
```js
console.log(a);
var a = 123;
```
等于
```js
var a;
console.log(a);
a = 123;
```
此时a为undefined

如果去掉var
```js
console.log(a);
a = 123;
```
此时报错  a is not defined

## 函数的声明提前
使用函数声明形式创建的函数function函数(){}

它会在所有代码执行之前就被创建

示例1：
```js
    fun();
    function fun() {
      console.log("我是一个fun函数")
    }
    var fun2 = function () {
      console.log("我是一个fun2函数")
    }
```
等于
```js
    function fun() {
      console.log("我是一个fun函数")
    }
    fun();
    var fun2 = function () {
      console.log("我是一个fun2函数")
    }
```
输出: 我是一个fun函数

示例2：
```js
    fun2();
    function fun() {
      console.log("我是一个fun函数")
    }
    var fun2 = function () {
      console.log("我是一个fun2函数")
    }
```
输出：fun2 is not a function

这里的fun2会被提前声明，但是只是声明一个var fun2,没有进行赋值，所以会报错

---
title: JS中的栈和堆
date: 2020-07-24
tags:
 - JS
categories:
 - 前端笔记
---

## 栈和堆
栈(stack)：栈会自动分配内存空间，会自动释放，存放基本类型，简单的数据段，占据固定大小的空间。

基本类型：String，Number，Boolean，Null，Undefined

堆(heap):动态分配的内存，大小不定也不会自动释放，存放引用类型，指那些可能由多个值构成的对象，保存在堆内存中，包含引用类型的变量，实际上保存的不是变量本身，而是指向该对象的指针。

引用类型：Function，Array，Object

## 垃圾回收
现在各大浏览器通常用采用的垃圾回收有两种方法：标记清除、引用计数

### 标记清除
现代浏览器大多数采用这种方式：当变量进入环境时，将变量标记"进入环境"，当变量离开环境时，标记为:"离开环境"。某一时刻，垃圾回收器会过滤掉环境中的变量，以及被环境变量引用的变量，剩下的就是被视为准备回收的变量

算法流程：
1. 浏览器在运行的时候会给存储在内存中的所有变量都加上标记
2. 去掉环境中的变量以及被环境中引用的变量的标记
3. 如果还有变量有标记，就会被视为准备删除的变量
4. 垃圾回收机制完成内存的清除工作，销毁那些带标记的变量，并回收它们所占用的内存
### 引用计数
算法流程：
1. 声明了一个变量并将一个引用类型的值赋值给这个变量，这个引用类型值引用次数就是1
2. 同一个值又被赋值给另一个变量，这个引用类型的值引用次数加1
3. 当包含这个引用类型值的变量又被赋值另一个值了，那么这个引用类型的值的引用次数减1
4. 当引用次数变成0时，说明这个值需要解除引用
5. 当垃圾回收机制下次运行时，它就会释放引用次数为0的值所占用的内存

### 手动赋值null
```js
var obj = new Object();
obj = null;
```
创建一个obj对象，对象会在堆内存中创建一个空间存储，栈内存中的key为obj的value会指向堆内存中的该空间

当我们将obj赋值为null时，此时指向堆内存的链接就被断开了，此时堆内存中的那片空间就无法找到了，此时那片空间就是垃圾

在JS中拥有自动的垃圾回收机制，会自动将这样的垃圾对象从内存中销毁

当我们需要进行垃圾回收时，只需要使一个对象赋值为null就行

## 代码例子
### 示例1：
```js
let a = {};
b = '0';
c = 0;
a[b] = '哈哈';
a[c] = '嘿嘿';
console.log(a[b]);
```
输出：`嘿嘿`

解析：属性名不能重复，数字属性名==字符串属性名，所以后面的'嘿嘿’会覆盖前面的'哈哈'，因为key是一样的

### 示例2：
```js
let a = {};
b = Symbol('1');
c = Symbol('1');
a[b] = '哈哈';
a[c] = '嘿嘿';
console.log(a[b])
```
输出：`哈哈`

解析：Symbol创建是唯一值的,所以b和c不相等，所以输出`哈哈`

### 示例3
```js
let a = {};
b = {
  n: '1'
};
c = {
  m: '2'
};
a[b] = '哈哈';
a[c] = '嘿嘿';
console.log(a[b]);
```
输出：`嘿嘿`

解析：引用类型的都会转换成字符串，无论{ }里面的内容是什么，都会被转换成Object object，所以两次key相同，覆盖，输出`嘿嘿`